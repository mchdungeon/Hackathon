<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クリプトダンジョン</title>
  <link rel="stylesheet" href="css/reset.css">
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    let cocosGame = null;
    let command = null;
    let mchh = null;
    const  web3 = new Web3("https://mainnet.infura.io");

    const account = {
  address: null,
  balance: null
  }

  let assets = [];
  let heroes = [];

    async function getAssets(provider) {
  try{
    web3.setProvider(provider)
    if(window.ethereum){
      await ethereum.enable()
    }
    const accounts = await web3.eth.getAccounts()
    if(accounts.length > 0) {
      account.address = accounts[0];
      account.balance = await web3.eth.getBalance(accounts[0])
      setInterval(async () => {
        web3.eth.getAccounts().then(accounts => {
          // if (account.address != accounts[0]) {
          //   account.address = accounts[0];
          //   location.reload()
          // }
        })
      }, 100)
    }
    return this.ownedTokens(account);
  } catch (err) {
    alert(err)
  }
}

    async function ownedTokens(account) {
      const balance = await mchh.methods.balanceOf(account.address).call()
        if (balance == 0) {
          return []
        }
        const promises = []
        for (let i = 0; i < balance; i++) {
          promises.push(mchh.methods.tokenOfOwnerByIndex(account.address, i).call())
        }
        const result = await Promise.all(promises)
        return result
    }

    function getMetadata(provider) {
      this.getAssets(provider).then(async tokenIds => {
            const promises = [];
        for (var tokenId of tokenIds) {
          promises.push(axios.get("https://asia-northeast1-blockbase-bazaaar-sand.cloudfunctions.net/" + 'metadata?asset=mchh' + '&id=' + tokenId))
        }
        const results = await Promise.all(promises)
        for (var result of results) {
          heroes.push(result.data)
        }
          })
    }

    window.onload = function() {
      cocosGame = document.getElementById('content').contentWindow;
      command = { method:"setConfig", params:{ heroes: heroes} };

      let abi = [{"constant": true,"inputs": [{"name": "interfaceId","type": "bytes4"}],"name": "supportsInterface","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "mintingFinished","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "name","outputs": [{"name": "","type": "string"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"name": "tokenId","type": "uint256"}],"name": "getApproved","outputs": [{"name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "to","type": "address"},{"name": "tokenId","type": "uint256"}],"name": "approve","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [],"name": "totalSupply","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "from","type": "address"},{"name": "to","type": "address"},{"name": "tokenId","type": "uint256"}],"name": "transferFrom","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "owner","type": "address"},{"name": "index","type": "uint256"}],"name": "tokenOfOwnerByIndex","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [],"name": "unpause","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "to","type": "address"},{"name": "tokenId","type": "uint256"}],"name": "mint","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "from","type": "address"},{"name": "to","type": "address"},{"name": "tokenId","type": "uint256"}],"name": "safeTransferFrom","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "account","type": "address"}],"name": "isPauser","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "HERO_TYPE_OFFSET","outputs": [{"name": "","type": "uint16"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "_owner","type": "address"},{"name": "_tokenId","type": "uint256"}],"name": "mintHeroAsset","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "index","type": "uint256"}],"name": "tokenByIndex","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "to","type": "address"},{"name": "tokenId","type": "uint256"},{"name": "tokenURI","type": "string"}],"name": "mintWithTokenURI","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [],"name": "paused","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"name": "tokenId","type": "uint256"}],"name": "ownerOf","outputs": [{"name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [],"name": "renouncePauser","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "_heroType","type": "uint16"},{"name": "_supplyLimit","type": "uint16"}],"name": "setSupplyLimit","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "owner","type": "address"}],"name": "balanceOf","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [],"name": "finishMinting","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "account","type": "address"}],"name": "addPauser","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "_heroType","type": "uint16"}],"name": "getSupplyLimit","outputs": [{"name": "","type": "uint16"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [],"name": "pause","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [],"name": "symbol","outputs": [{"name": "","type": "string"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "account","type": "address"}],"name": "addMinter","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [],"name": "renounceMinter","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "_tokenURIPrefix","type": "string"}],"name": "setTokenURIPrefix","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "to","type": "address"},{"name": "approved","type": "bool"}],"name": "setApprovalForAll","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "account","type": "address"}],"name": "isMinter","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "from","type": "address"},{"name": "to","type": "address"},{"name": "tokenId","type": "uint256"},{"name": "_data","type": "bytes"}],"name": "safeTransferFrom","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [],"name": "tokenURIPrefix","outputs": [{"name": "","type": "string"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"name": "tokenId","type": "uint256"}],"name": "tokenURI","outputs": [{"name": "","type": "string"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"name": "owner","type": "address"},{"name": "operator","type": "address"}],"name": "isApprovedForAll","outputs": [{"name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"inputs": [],"payable": false,"stateMutability": "nonpayable","type": "constructor"},{"anonymous": false,"inputs": [],"name": "Paused","type": "event"},{"anonymous": false,"inputs": [],"name": "Unpaused","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "account","type": "address"}],"name": "PauserAdded","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "account","type": "address"}],"name": "PauserRemoved","type": "event"},{"anonymous": false,"inputs": [],"name": "MintingFinished","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "account","type": "address"}],"name": "MinterAdded","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "account","type": "address"}],"name": "MinterRemoved","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "from","type": "address"},{"indexed": true,"name": "to","type": "address"},{"indexed": true,"name": "tokenId","type": "uint256"}],"name": "Transfer","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "owner","type": "address"},{"indexed": true,"name": "approved","type": "address"},{"indexed": true,"name": "tokenId","type": "uint256"}],"name": "Approval","type": "event"},{"anonymous": false,"inputs": [{"indexed": true,"name": "owner","type": "address"},{"indexed": true,"name": "operator","type": "address"},{"indexed": false,"name": "approved","type": "bool"}],"name": "ApprovalForAll","type": "event"}]
      let contract = "0x273f7F8E6489682Df756151F5525576E322d51A3";

      mchh = new web3.eth.Contract(
      abi,
      contract
    )

  if (window.ethereum) {
    this.getMetadata(ethereum);
    } else {
    this.getMetadata(web3.currentProvider);
        }

  }
    function communicate(res){
      if(!command){
        window.alert("ゲームがロードされていません。")
        location.reload();
      }
      document.getElementById("yes").disabled = true;
      document.getElementById("no").disabled = true;
      command.params.import = res;
      if (heroes.length <= 3 && res){
        command.params.import = false;
        window.alert("ヒーローが足りません。")
      }
      cocosGame.postMessage(command,'*');
    }

  </script>
</head>
<body>
  <div>
  <p>ヒーローをインポートしますか？</p>
  <p>※ゲームがロードされてからボタンを押してください。</p>
  <p>※ヒーローは最低３体必要です。</p>
  <button id = "yes" onclick="communicate(true)">はい</button>
  <button id = "no" onclick="communicate(false)">いいえ</button>
  </div>
  <iframe id='content' src="http://localhost:3000/web-desktop/index.html" style="width: 100%;
  height: 1200px;"></iframe>
</body>
</html>
